<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="ProxyToNode" stopProcessing="true">
          <match url="^(auth/callback|)$" /> 
          <!-- aqui voc칡 lista as rotas da sua app que ficam no Node -->
          <action type="Rewrite" url="http://localhost:3000/{R:0}" />
        </rule>
        <rule name="StaticFiles" stopProcessing="true">
          <match url="^(css|js|img|fonts)/.*" />
          <action type="Rewrite" url="http://localhost:3000/{R:0}" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>


Detailed Error Information:
Module	   IIS Web Core
Notification	   MapRequestHandler
Handler	   StaticFile
Error Code	   0x80070002
Requested URL	   https://superfeira.intranet.bb.com.br:443/sso/oauth2/authorize?response_type=code&client_id=superfeira&redirect_uri=https%3A%2F%2Fsuperfeira.intranet.bb.com.br%2Fauth%2Fcallback&scope=bbprofile
Physical Path	   C:\workspace\devSuperfsa\sso\oauth2\authorize
Logon Method	   Anonymous
Logon User	   Anonymous

<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="ReverseProxyToNode" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <!-- S칩 proxyar se n칚o for um arquivo f칤sico -->
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <!-- S칩 proxyar se n칚o for uma pasta f칤sica -->
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>

<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="ReverseProxyToNode" stopProcessing="true">
          <match url="(.*)" />
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>

https://superfeira.intranet.bb.com.br/sso/oauth2/authorize?response_type=code&client_id=superfeira&redirect_uri=https%3A%2F%2Fsuperfeira.intranet.bb.com.br%2Fauth%2Fcallback&scope=bbprofile



1111111111111111111111111111111111111

const express = require('express');
const axios = require('axios');
const path = require('path');
const cookieSession = require('cookie-session');
require('dotenv').config();

const app = express();
const PORT = 3000;

// Permite o Express funcionar corretamente atr치s do IIS (evita erro no hostname)
app.set('trust proxy', true);

// ======= CONFIGURA칂칏ES =========
const CLIENT_ID = process.env.CLIENT_ID;
const CLIENT_SECRET = process.env.CLIENT_SECRET;
const REDIRECT_URI = process.env.REDIRECT_URI;

// 游 URLs fixas da autentica칞칚o do BB (N츾O depende do host atual)
const AUTH_URL = 'https://login.intranet.bb.com.br/sso/oauth2/authorize';
const TOKEN_URL = 'https://login.intranet.bb.com.br/sso/oauth2/access_token';
const USERINFO_URL = 'https://login.intranet.bb.com.br/sso/oauth2/userinfo';

// ======= SESS츾O VIA COOKIE ========
app.use(
  cookieSession({
    name: 'session',
    keys: ['chave-super-secreta-aqui'],
    maxAge: 24 * 60 * 60 * 1000, // 1 dia
    secure: true,
    sameSite: 'lax',
  })
);

// ======= ROTA PRINCIPAL ===========
app.get('/', async (req, res) => {
  if (req.session?.user) {
    // Se autenticado, mostra o index
    return res.sendFile(path.join(__dirname, 'dist', 'index.html'));
  }

  // Redireciona para o login do BB
  const authUrl = `${AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=bbprofile`;
  return res.redirect(authUrl);
});

// ======= CALLBACK DO OAUTH2 =========
app.get('/auth/callback', async (req, res) => {
  const code = req.query.code;

  if (!code) {
    return res.status(400).send('C칩digo de autentica칞칚o ausente.');
  }

  try {
    const authHeader = Buffer.from(`${CLIENT_ID}:${CLIENT_SECRET}`).toString('base64');

    const tokenResponse = await axios.post(
      TOKEN_URL,
      new URLSearchParams({
        code,
        grant_type: 'authorization_code',
        redirect_uri: REDIRECT_URI,
      }),
      {
        headers: {
          Authorization: `Basic ${authHeader}`,
          'Content-Type': 'application/x-www-form-urlencoded',
        },
      }
    );

    const accessToken = tokenResponse.data.access_token;

    // Pega os dados do usu치rio logado
    const userInfo = await axios.get(USERINFO_URL, {
      headers: { Authorization: `Bearer ${accessToken}` },
    });

    // Salva os dados na sess칚o
    req.session.user = userInfo.data;

    return res.redirect('/');
  } catch (error) {
    console.error('Erro no callback:', error.response?.data || error.message);
    return res.status(500).send('Erro na autentica칞칚o OAuth2.');
  }
});

// ======= BLOQUEIA ACESSOS SEM LOGIN =======
app.use((req, res, next) => {
  if (req.session?.user) {
    return next();
  }

  // Redireciona para login se tentar acessar outros arquivos sem sess칚o
  const authUrl = `${AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=bbprofile`;
  return res.redirect(authUrl);
});

// ======= SERVE OS ARQUIVOS EST츼TICOS =========
app.use(express.static(path.join(__dirname, 'dist')));

// ======= INICIA O SERVIDOR =========
app.listen(PORT, () => {
  console.log(`Servidor rodando em http://localhost:${PORT}`);
});

